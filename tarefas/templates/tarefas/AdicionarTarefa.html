{% extends "diaAbertoConf/Home.html" %}

	{% block content %}
    	<div class="mt-3 mx-2 mb-5 pb-5">
			<nav aria-label="breadcrumb">
				<ol class="breadcrumb bg-white">
					<li class="breadcrumb-item"><a href="{% url 'diaAbertoConf:index' %}">In√≠cio</a></li>
					<li class="breadcrumb-item"><a href="#">Tarefas</a></li>
					<li class="breadcrumb-item active">Adicionar Tarefa</li>
				</ol>
			</nav>
    	    <div class = "row">
    		    <div class = "col-sm-4 offset-sm-4">
                    <h4 style="text-align:center;">Adicionar Tarefa</h4>
    		    </div>
            </div>
    	    <hr class="mx-5">
    	    <div class = "row">
    		    <div class = "col-sm-6  offset-sm-3">
					<form action = "{% url 'tarefas:createTarefa' %}" method="post">
						{% csrf_token %}
						<div class="form-group row">
    						<label class="form-check-label col-sm-3"> {{formTarefa.nome.label}} </label>
    						<div class="col-sm-8">
                                {{formTarefa.nome}}
    						</div>
  						</div>
  						<div class="form-group row">
    						<label class="form-check-label col-sm-3"> {{formTarefa.descricao.label}} </label>
    						<div class="col-sm-8">
                                {{formTarefa.descricao}}
    						</div>
  						</div>
  						<div class="form-group row pb-5">
                            <label class="form-check-label col-sm-3"> {{formTarefa.tipoTarefa.label}} </label>
    						<div class="col-sm-8">
                                {{formTarefa.tipoTarefa}}
    						</div>
  						</div>
                        <hr>
						<div class="TarefaAtividade" style="display:none">
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaAtividade.atividade.label}} </label>
    							<div class="col-sm-8">
                        	        {{formTarefaAtividade.atividade}}
    							</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaAtividade.sessaoAtividade.label}} </label>
    							<div class="col-sm-8">
                        	        {{formTarefaAtividade.sessaoAtividade}}
    							</div>
  							</div>
							<hr>
						</div>
						<div class="TarefaTransporte" style="display:none">
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.dia.label}} </label>
    							<div class="col-sm-8">
                        	        <input id="dia" type="date" name="dia" class="form-control date-Set" min="{{diaAberto.data_inicio}}" max="{{diaAberto.data_fim}}">
    							</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.horario.label}} </label>
    							<div class="col-sm-8">
						      		<input id="horario" type="time" name="horario" class="form-control">
    							</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.inscricao.label}} </label>
    							<div class="col-sm-8">
                        	        {{formTarefaTransporte.inscricao}}
    							</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.sessaoAtividade_origem.label}} </label>
    							<div class="col-sm-8">
                        	        {{formTarefaTransporte.sessaoAtividade_origem}}
    							</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.origem.label}} </label>
    							<div class="col-sm-8">
									<input type="text" name="origem" class="form-control" id="id_origem">    							
								</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.sessaoAtividade_destino.label}} </label>
    							<div class="col-sm-8">
                        	        {{formTarefaTransporte.sessaoAtividade_destino}}
    							</div>
  							</div>
							<div class="form-group row">
                        	    <label class="form-check-label col-sm-3"> {{formTarefaTransporte.destino.label}} </label>
    							<div class="col-sm-8">
									<input type="text" name="destino" class="form-control" id="id_destino">    							
								</div>
  							</div>
							<hr>
						</div>
						<div class="form-group row">
							<div class="col-sm-2">
								<a type="button" class="btn btn-secondary" href="#">Cancelar</a>
							</div>
							<div class="col-sm-2">
								<button type="submit" class="btn btn-primary">Guardar</button>
							</div>
						</div>
					</form>
    		    </div>
    	    </div>
    	</div>
	{% endblock %}

	{% block js %}
	<script type='text/javascript'>	

		function addLocal(prefix){
			if( $('select[name=sessaoAtividade_' + prefix +']').val()){
				sessao_atividadeid = $('select[name=sessaoAtividade_' + prefix +']').val();
				request_url = '/Tarefas/getLocal_Sessao/' + sessao_atividadeid

				$.ajax({
					url: request_url,
					dataType: "json",
					success: function(data){
						$.each(data, function(index, text){
							$('input[name=' + prefix +']').val(text)
						})
					}
				})
			}else
				$('input[name=' + prefix +']').val('');
		}

		function addProximaAtividade(){
			if( $('select[name=sessaoAtividade_origem').val()){
				
				$('select[name=sessaoAtividade_destino]').find('option').each(function(){
					$(this).remove();
				})

				grupoId = $('select[name=inscricao]').val()
				hora = $('input[name=horario]').val()
				request_url ='/Tarefas/getSessoes_InscricaoNext/'+ grupoId + '/' + hora 

				$.ajax({
					url: request_url,
					dataType: "json",
					success: function(data){
						$.each(data, function(index, text){
							$('select[name=sessaoAtividade_destino]').append(
								$('<option></option>').val(index).html(text)
							)
						})
						addLocal('destino')
					},
				});

			}
		}

		function addAtividadeAtual(){
			//console.log("Atividade Atual");

			$('select[name=sessaoAtividade_origem]').find('option').each(function(){
				$(this).remove();
			})
			$('select[name=sessaoAtividade_destino]').find('option').each(function(){
					$(this).remove();
			})
			$('input[name=origem]').val('');
			$('input[name=destino]').val('');


			grupoId = $('select[name=inscricao]').val()
			hora = $('input[name=horario]').val()
			request_url ='/Tarefas/getSessoes_Inscricao/'+ grupoId + '/' + hora 

			$.ajax({
				url: request_url,
				dataType: "json",
				success: function(data){
					$.each(data, function(index, text){
						$('select[name=sessaoAtividade_origem]').append(
							$('<option></option>').val(index).html(text)
						)
					})
					addLocal('origem');
					addProximaAtividade();
				},
			});

		}

		$('input[name=dia]').change(function(){
			//console.log("Date was changed");
			$('select[name=inscricao]').find('option').each(function(){
				$(this).remove();
			})

			date = $(this).val();
			//console.log(date)
			request_url = '/Tarefas/getInscricoesByDate/' + date;
			$.ajax({
				url: request_url,
				dataType:"json",
				success: function(data){
					$.each(data, function(index, text){
						$('select[name=inscricao]').append(
							$('<option></option>').val(index).html(text)
						)
					})
					if ($('input[name=horario]').val() && Object.keys(data).length > 0)
						addAtividadeAtual();
				}
			});

		})


		$('select[name=inscricao').change(function(){
			if ($('input[name=horario]').val())
				addAtividadeAtual();			
		})

		$('input[name=horario]').change(function(){
			if ($('select[name=inscricao]').val())
				addAtividadeAtual();
		})

		$('select[name=sessaoAtividade_origem]').change(function(){
			addLocal('origem');
		})

		$('select[name=sessaoAtividade_destino]').change(function(){
			addLocal('destino');
		})

		$('select[name=atividade]').change(function(){

			$('select[name=sessaoAtividade]').find('option').each(function(){
				$(this).remove();
			})

    		Atividadeid = $(this).val();
    		request_url = '/Tarefas/getSessoes/' + Atividadeid;
    	    $.ajax({
    	        url: request_url,
				dataType: "json",
    	        success: function(data){
					$.each(data, function(index, text){
						$('select[name=sessaoAtividade]').append(
							$('<option></option>').val(index).html(text)
						)
					})
				},
			});
		})


		$('input[name=tipoTarefa').change(function(){
			if($(this).val() == 'Atividade'){
				$('.TarefaAtividade').show();
				$('.TarefaTransporte').hide();
				$('.TarefaTransporte').find('input, select').each(function(){
					$(this).val('');
					
					if($(this).is('select')){
						$(this).find('option').each(function(){
							$(this).remove();
						})
					}
				})
			}else{
				$('.TarefaTransporte').show();
				$('.TarefaAtividade').hide();
				$('.TarefaTransporte').find('select').each(function(){	
				})
			}
		})

	</script>
	{% endblock %}
